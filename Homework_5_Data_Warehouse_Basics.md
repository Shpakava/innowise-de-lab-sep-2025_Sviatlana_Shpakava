Проектирование Data Warehouse (хранилища данных) для бизнес-области, представляющей систему бронирования в ресторане.

1. Определение конкретного бизнес-процесса для выбранной области, например:
- клиент реализует возможность поиска доступного к заказу стола на определенную дату и количество гостей;
- сотрудник ресторана фиксирует бронь различными способами (телефон, онлайн, на месте);
- сотрудники ресторана управляют статусами бронирований (зарезервировано, изменено, заказ отменен).

2. Определение уровня детализации (grain) бизнес-процесса:
- уровень детализации для таблицы фактов (fact_orders) представляет собой связь через одну строку в указанной таблице с каждой уникальной таблицей измерений, то есть представляет отдельное бронирование, осуществленное клиентом (дата, стол, способ заказа стола).

3. Определение таблиц измерений (dimension tables).
Таблица dim_date предназначена для хранения сведений о времени бронирования. Данная таблица содержит информацию о:
date_sk (суррогатный ключ, уникальный числовой идентификатор для каждой даты);
date_id (идентификатор даты);
date (дата бронирования);
weekend (сведения о том, является ли выбранная дата выходным днем);
holiday (сведения о том, является ли выбранная дата праздничным днем).
Таблица dim_client хранит информацию о клиентах ресторана, реализующих бронирование:
client_sk (суррогатный ключ, уникальный числовой идентификатор для каждого клиента);
client_id (идентификатор клиента);
name (имя клиента);
surname (фамилия клиента);
phone (номер телефона клиента);
email (адрес электронной почты клиента);
сity (город проживания клиента);
сountry (страна проживания клиента);
status (статус клиента в программе лояльности, например, VIP).
Таблица dim_staff хранит информацию о сотрудниках ресторана, которые имеют право обрабатывать бронирования:
staff_sk (суррогатный ключ, уникальный числовой идентификатор для каждого сотрудника);
staff_id (идентификатор сотрудника);
name (имя сотрудника);
surname (фамилия сотрудника);
job_title (должность сотрудника).
Таблица dim_table содержит информацию о столах ресторана:
table_sk (суррогатный ключ, уникальный числовой идентификатор для каждого стола);
table_id (идентификатор стола);
table_number (номер стола);
number_of_clients (максимальное количество гостей, которое может принять стол);
location (месторасположение стола в ресторане, например, терраса, большой зал, малый зал, VIP-зона, бар).
Таблица dim_order_status хранит информацию о статусах бронирования:
order_status_sk (суррогатный ключ, уникальный числовой идентификатор для каждого статуса бронирования);
status_id (идентификатор статуса);
status_name (именование статуса, например, «подтверждено», «ожидается подтверждение», «отменено», «завершено»);
status_comment (примечание к заказу – отдельные пожелания клиента).
Таблица dim_order_way хранит данные о способах бронирования:
order_way_sk (суррогатный ключ, уникальный числовой идентификатор для каждого способа бронирования);
order_way_id (идентификатор способа бронирования);
way_name (название способа бронирования, например, онлайн, телефон, живая очередь).

4. Определение таблицы фактов (fact table).
Таблица fact_orders хранит основные характеристики и внешние ключи к таблицам измерений:
orders_sk (суррогатный ключ, уникальный числовой идентификатор для каждого факта бронирования);
date_sk (ссылка на таблицу dim_date, содержащая сведения о дате бронирования);
client_sk (ссылка на таблицу dim_client, содержащая сведения о клиенте, сделавшем бронь);
staff_sk (ссылка на таблицу dim_staff, содержащая сведения о сотруднике, принявшем бронь);
table_sk (ссылка на таблицу dim_table, содержащая сведения о характеристике забронированного стола);
order_status_sk (ссылка на таблицу dim_order_status, содержащая сведения об итоговом статусе бронирования);
order_way_sk (ссылка на таблицу dim_order_way, содержащая данные о способе бронирования);
price (общая стоимость заказа до скидки);
discount (размер скидки на заказ).

5. Моделирование физической модели.
Для реализации данного хранилища данных использована модель Star Schema. Основная таблица фактов fact_orders связана со различными таблицами измерений напрямую.
Указанная модель выбрана, исходя из простоты ее реализации, поскольку она имеет более низкий уровень нормализации.

6. Примеры аналитических запросов, которые дают возможность ответить на ключевые вопросы рассматриваемого бизнес-процесса.
- определение количества заказов в зависимости от способа бронирования и общей суммы дохода, полученной от этих заказов:

SELECT way_name, COUNT(orders_sk) AS count_orders, SUM(price - discount) AS revenue
FROM fact_orders INNER JOIN dim_order_way ON fact_orders.order_way_sk = dim_order_way.order_way_sk
GROUP BY way_name;

- определение 5 наиболее активных клиентов, исходя из количества заказов и потраченной суммы:

SELECT CONCAT(name, surname) AS client_full_name, email, phone, status, COUNT(orders_sk) AS count_orders, SUM(price – discount) AS client_spent
FROM fact_orders INNER JOIN dim_client ON fact_orders.client_sk = dim_client.client_sk
GROUP BY client_full_name, email, phone, status
ORDER BY count_orders DESC, client_spent DESC
LIMIT 5;

- определение 5 наиболее популярных столов и их доходности:

SELECT table_number, location, number_of_clients, COUNT(orders_sk) AS total_orders, SUM(price - discount) AS revenue_from_table
FROM fact_orders INNER JOIN dim_table ON fact_orders.table_sk = dim_table.table_sk
GROUP BY table_number, location, number_of_clients
ORDER BY total_orders DESC, revenue_from_table DESC
LIMIT 5;

- определение количества клиентов каждого статуса, общего количества их заказов, среднего чека для каждой группы клиентов:

SELECT status, COUNT(DISTINCT fact_orders.client_sk) AS clients_in_status, COUNT(orders_sk) AS count_orders_by_status, AVG(price - discount) AS avg_value_by_status
FROM fact_orders INNER JOIN dim_client ON fact_orders.client_sk = dim_client.client_sk
GROUP BY status 
ORDER BY avg_value_by_status DESC;
